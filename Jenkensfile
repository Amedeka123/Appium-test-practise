pipeline {
  agent any

  options {
    timestamps()
  }

  tools {
    jdk    'JDK21'        // Must match the name you set in Jenkins â†’ Tools
    maven  'Maven_3.9.9'  // Same here
    nodejs 'Node18'       // NodeJS for Appium
  }

  environment {
    ANDROID_HOME     = 'C:\\Users\\israe\\AppData\\Local\\Android\\Sdk'
    ANDROID_SDK_ROOT = 'C:\\Users\\israe\\AppData\\Local\\Android\\Sdk'

    // Include adb and npm global bin for appium CLI (if you use it)
    PATH = "${env.PATH};${ANDROID_HOME}\\platform-tools;C:\\Users\\${env.USERNAME}\\AppData\\Roaming\\npm"

    // Use exact AVD name (quoted in commands if it has spaces)
    AVD_NAME   = 'Pixel_8_Pro'
    APPIUM_PORT = '4723'

    // Explicit emulator path (no reliance on PATH)
    EMULATOR_EXE = 'C:\\Users\\israe\\AppData\\Local\\Android\\Sdk\\emulator\\emulator.exe'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Sanity Check') {
      steps {
        bat 'java -version'
        bat 'mvn -v'
        bat 'node -v'
        bat 'npm -v'
        bat 'adb --version'
        bat 'adb devices'
        bat '"%EMULATOR_EXE%" -version'
      }
    }

    stage('Start Emulator') {
      when { expression { return env.AVD_NAME?.trim() } }
      steps {
        // Start emulator explicitly via full path
        bat 'start "" /B "%EMULATOR_EXE%" -avd "%AVD_NAME%" -no-snapshot -gpu swiftshader_indirect -no-boot-anim -accel on -no-audio -no-window'

        // Wait for boot completion
        bat '''
          adb wait-for-device
          for /l %%x in (1,1,180) do (
            adb shell getprop sys.boot_completed 2>nul | findstr 1 >nul && goto :ready
            timeout /t 1 >nul
          )
          echo Emulator failed to boot in time & exit /b 1
          :ready
        '''
      }
    }

    stage('Run Tests') {
      steps {
        bat 'mvn clean test'
      }
    }
  }

  post {
    always {
      // Archive test reports
      junit '**/surefire-reports/*.xml'
      archiveArtifacts artifacts: 'appium.log', onlyIfSuccessful: false

      // Kill the emulator and Appium after build
      bat 'adb -s emulator-5554 emu kill 2>nul || ver >nul'
      bat 'taskkill /F /IM qemu-system-x86_64.exe   2>nul || ver >nul'
      bat 'taskkill /F /IM qemu-system-x86_64w.exe  2>nul || ver >nul'
      bat 'for /f "tokens=5" %%p in (\'netstat -ano ^| findstr :%APPIUM_PORT% ^| findstr LISTENING\') do taskkill /F /PID %%p'
    }
  }
}
